

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>jl_spectra_2_structure.jl_spectra_2_structure &mdash; jl_spectra_2_structure 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> jl_spectra_2_structure
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../jl_spectra_2_structure.html">jl_spectra_2_structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_validation.html">cross_validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../neural_network.html">neural_network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../primary_data_creation/index.html">primary_data_creation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting_tools.html">plotting_tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../error_metrics.html">error_metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">Examples</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">jl_spectra_2_structure</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>jl_spectra_2_structure.jl_spectra_2_structure</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for jl_spectra_2_structure.jl_spectra_2_structure</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Dec 19 11:05:24 2017</span>

<span class="sd">@author: lansf</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="k">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">imblearn.over_sampling</span> <span class="k">import</span> <span class="n">RandomOverSampler</span>

<div class="viewcode-block" id="get_default_data_paths"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.get_default_data_paths">[docs]</a><span class="k">def</span> <span class="nf">get_default_data_paths</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns default frequencies to project intensities onto as well as default</span>
<span class="sd">    paths for locations of the pure and mixture spectroscopic data.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    </span>
<span class="sd">    nanoparticle_path : str</span>
<span class="sd">        File path where nanoparticle or single adsorbate data will be saved.</span>
<span class="sd">        </span>
<span class="sd">    isotope_path : str</span>
<span class="sd">        File path where isotope data for CO and NO will be saved.</span>

<span class="sd">    high_coverage_path : str</span>
<span class="sd">        File path where high coverage data for CO will be saved.</span>
<span class="sd">        </span>
<span class="sd">    cross_validation_path : str</span>
<span class="sd">        Directory location cross validation data will be stored.</span>

<span class="sd">    coverage_scaling_path : str</span>
<span class="sd">        File path where coverage scaling coefficients will be saved.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;data/&#39;</span><span class="p">)</span>
    <span class="n">nanoparticle_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;dft_nanoparticle/single_&#39;</span><span class="o">+</span><span class="n">adsorbate</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span>
    <span class="n">isotope_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;dft_surface/isotope_&#39;</span><span class="o">+</span><span class="n">adsorbate</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span>
    <span class="n">high_coverage_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;dft_surface/high_coverage_&#39;</span><span class="o">+</span><span class="n">adsorbate</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span>
    <span class="n">coverage_scaling_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span><span class="s1">&#39;coverage_scaling_params_&#39;</span><span class="o">+</span><span class="n">adsorbate</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span> 
    <span class="k">return</span> <span class="p">(</span><span class="n">nanoparticle_path</span><span class="p">,</span> <span class="n">isotope_path</span><span class="p">,</span> <span class="n">high_coverage_path</span>\
           <span class="p">,</span> <span class="n">coverage_scaling_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="IR_GEN"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN">[docs]</a><span class="k">class</span> <span class="nc">IR_GEN</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ADSORBATE</span><span class="o">=</span><span class="s1">&#39;CO&#39;</span><span class="p">,</span> <span class="n">INCLUDED_BINDING_TYPES</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">TARGET</span><span class="o">=</span><span class="s1">&#39;binding_type&#39;</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="o">=</span><span class="kc">None</span>\
                 <span class="p">,</span> <span class="n">nanoparticle_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">high_coverage_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coverage_scaling_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">TARGET</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;binding_type&#39;</span><span class="p">,</span><span class="s1">&#39;GCN&#39;</span><span class="p">,</span><span class="s1">&#39;combine_hollow_sites&#39;</span><span class="p">],</span> <span class="s2">&quot;incorrect TARGET given&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">INCLUDED_BINDING_TYPES</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="s2">&quot;Included Binding Types should be a list&quot;</span>
        <span class="c1">#number of target variables.</span>
        <span class="n">nano_path</span><span class="p">,</span> <span class="n">isotope_path</span><span class="p">,</span> <span class="n">high_cov_path</span>\
           <span class="p">,</span> <span class="n">cov_scale_path</span> <span class="o">=</span> <span class="n">get_default_data_paths</span><span class="p">(</span><span class="n">ADSORBATE</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">nanoparticle_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nanoparticle_path</span> <span class="o">=</span> <span class="n">nano_path</span>
        <span class="k">if</span> <span class="n">ADSORBATE</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NO&#39;</span><span class="p">,</span><span class="s1">&#39;CO&#39;</span><span class="p">]:</span>
            <span class="n">max_coordination</span><span class="o">=</span><span class="mi">4</span>
            <span class="k">if</span> <span class="n">coverage_scaling_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coverage_scaling_path</span> <span class="o">=</span> <span class="n">cov_scale_path</span>
            <span class="k">if</span> <span class="n">ADSORBATE</span> <span class="o">==</span> <span class="s1">&#39;CO&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">high_coverage_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">high_coverage_path</span> <span class="o">=</span> <span class="n">high_cov_path</span>
        <span class="k">elif</span> <span class="n">ADSORBATE</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;C2H4&#39;</span><span class="p">]:</span>
            <span class="n">max_coordination</span> <span class="o">=</span> <span class="mi">2</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">nanoparticle_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="n">nanoparticle_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="n">Xfreq_ALL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;FREQUENCIES&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">is_local_minima</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Xfreq_ALL</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">BINDING_TYPES_unfiltered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;CN_ADSORBATE&#39;</span><span class="p">])</span>
        <span class="n">max_forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;MAX_FORCE&#39;</span><span class="p">])</span>
        <span class="n">is_adsorbed</span> <span class="o">=</span> <span class="n">BINDING_TYPES_unfiltered</span> <span class="o">&gt;</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">TARGET</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;binding_type&#39;</span><span class="p">,</span><span class="s1">&#39;combine_hollow_sites&#39;</span><span class="p">]:</span>
            <span class="n">NUM_TARGETS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">INCLUDED_BINDING_TYPES</span><span class="p">)</span>
        <span class="n">correct_coordination</span> <span class="o">=</span> <span class="n">BINDING_TYPES_unfiltered</span> <span class="o">&lt;=</span> <span class="n">max_coordination</span>
        <span class="n">small_force</span> <span class="o">=</span> <span class="n">max_forces</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        <span class="n">select_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">is_local_minima</span><span class="p">,</span><span class="n">is_adsorbed</span><span class="p">,</span><span class="n">small_force</span><span class="p">,</span><span class="n">correct_coordination</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">nanoparticle_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">nanoparticle_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nanoparticle_data</span><span class="p">[</span><span class="n">key</span><span class="p">])[</span><span class="n">select_files</span><span class="p">]</span>
        <span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;INTENSITIES&#39;</span><span class="p">][</span><span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;FREQUENCIES&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">BINDING_TYPES_with_4fold</span> <span class="o">=</span> <span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;CN_ADSORBATE&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;combine_hollow_sites&#39;</span><span class="p">:</span>
            <span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;CN_ADSORBATE&#39;</span><span class="p">][</span><span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;CN_ADSORBATE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">NUM_TARGETS</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;grouping hollow sites&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BINDING_TYPES_with_4fold</span> <span class="o">=</span> <span class="n">BINDING_TYPES_with_4fold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TARGET</span> <span class="o">=</span> <span class="n">TARGET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_TARGETS</span> <span class="o">=</span> <span class="n">NUM_TARGETS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GCNlabels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X0cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;FREQUENCIES&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;INTENSITIES&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;FREQUENCIES&#39;</span><span class="p">]))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BINDING_TYPES</span> <span class="o">=</span> <span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;CN_ADSORBATE&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GCNList</span> <span class="o">=</span> <span class="n">nanoparticle_data</span><span class="p">[</span><span class="s1">&#39;GCN&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NANO_PATH</span> <span class="o">=</span> <span class="n">nanoparticle_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HIGH_COV_PATH</span> <span class="o">=</span> <span class="n">high_coverage_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COV_SCALE_PATH</span> <span class="o">=</span> <span class="n">coverage_scaling_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ADSORBATE</span> <span class="o">=</span> <span class="n">ADSORBATE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">INCLUDED_BINDING_TYPES</span> <span class="o">=</span> <span class="n">INCLUDED_BINDING_TYPES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COVERAGE</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="IR_GEN.get_GCNlabels"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN.get_GCNlabels">[docs]</a>    <span class="k">def</span> <span class="nf">get_GCNlabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">showfigures</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figure_directory</span><span class="o">=</span><span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="n">BINDING_TYPE_FOR_GCN</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial number of targets: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_TARGETS</span><span class="p">))</span>
        <span class="n">ADSORBATE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADSORBATE</span>
        <span class="n">NUM_TARGETS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_TARGETS</span>
        <span class="n">GCNList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GCNList</span>
        <span class="n">BINDING_TYPES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BINDING_TYPES</span>
        <span class="n">GCNList_selected</span> <span class="o">=</span> <span class="n">GCNList</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">BINDING_TYPES</span><span class="p">,</span><span class="n">BINDING_TYPE_FOR_GCN</span><span class="p">)]</span>
        <span class="n">KC</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">NUM_TARGETS</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">GCNList_selected</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">KC_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NUM_TARGETS</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">KC_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KC</span><span class="o">.</span><span class="n">labels_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">GCNList_selected</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_TARGETS</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">KC_new</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KC</span><span class="o">.</span><span class="n">labels_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">KC</span><span class="o">.</span><span class="n">labels_</span><span class="p">,</span> <span class="n">KC_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>\
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">GCNList_selected</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">KC</span><span class="o">.</span><span class="n">labels_</span><span class="p">,</span> <span class="n">KC_new</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="kc">False</span><span class="p">])]</span>
        <span class="n">KC2class</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">KC_new</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">KC_new</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)))</span>
        <span class="n">KCclass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">KC2class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">KC</span><span class="o">.</span><span class="n">labels_</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_TARGETS</span><span class="o">-</span><span class="mi">1</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">NUM_IN_CLASS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">KCclass</span><span class="p">[</span><span class="n">KCclass</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">NUM_IN_CLASS</span> <span class="o">&lt;</span> <span class="n">Minimum</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_TARGETS</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">KC2class</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">KC2class</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ii</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">})</span>
                <span class="n">KCclass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">KC2class</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">KC</span><span class="o">.</span><span class="n">labels_</span><span class="p">])</span>
        <span class="n">NUM_IN_CLASS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">KCclass</span><span class="p">[</span><span class="n">KCclass</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">NUM_IN_CLASS</span> <span class="o">&lt;</span> <span class="n">Minimum</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_TARGETS</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">KC2class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">KC2class</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">i</span><span class="p">:</span><span class="n">KC2class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span>
        <span class="n">NUM_IN_CLASS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">KCclass</span><span class="p">[</span><span class="n">KCclass</span> <span class="o">==</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">NUM_IN_CLASS</span> <span class="o">&lt;</span> <span class="n">Minimum</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_TARGETS</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">KC2class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">KC2class</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">i</span><span class="p">:</span><span class="n">KC2class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span>
        <span class="n">KCclass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">KC2class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">KC</span><span class="o">.</span><span class="n">labels_</span><span class="p">])</span>

        <span class="n">NUM_TARGETS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">KCclass</span><span class="p">))</span>

        <span class="n">GCNlabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">GCNList</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">GCNlabels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">BINDING_TYPES</span><span class="p">,</span><span class="n">BINDING_TYPE_FOR_GCN</span><span class="p">)]</span> <span class="o">=</span> <span class="n">KCclass</span>
        <span class="n">BreakPoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">810</span><span class="p">)</span>
        <span class="n">BreakLabels</span> <span class="o">=</span> <span class="n">KC</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">BreakPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">BreakLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">KC2class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">BreakLabels</span><span class="p">]</span>
        <span class="n">BreakMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">BreakPoints</span><span class="p">[</span><span class="n">BreakLabels</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">BreakMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">BreakPoints</span><span class="p">[</span><span class="n">BreakLabels</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">showfigures</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">GCNList_selected</span><span class="p">,</span> <span class="n">GCNList_selected</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">KC</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">BreakMax</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;GCN&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;GCN&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">])</span>
            <span class="n">BreakString</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">BreakMin</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">BreakMax</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">BreakString</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                           <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">BreakString</span><span class="p">)]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="c1">#ax = plt.subplot()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">GCNlabels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">BINDING_TYPES</span><span class="p">,</span><span class="n">BINDING_TYPE_FOR_GCN</span><span class="p">)],</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="o">+</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1">#ax.set_xticklabels(greater_than)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;GCN Group&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;DFT Samples&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">BreakString</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">rcParams</span>
            <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;figure.autolayout&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">figure_directory</span> <span class="o">==</span> <span class="s1">&#39;show&#39;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
            <span class="c1">#ax = plt.subplot()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">GCNlabels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">BINDING_TYPES</span><span class="p">,</span><span class="n">BINDING_TYPE_FOR_GCN</span><span class="p">)],</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="o">+</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1">#ax.set_xticklabels(greater_than)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;GCN Group&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;DFT Samples&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">figure_directory</span> <span class="o">==</span> <span class="s1">&#39;show&#39;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">figure_directory</span><span class="p">,</span><span class="n">ADSORBATE</span><span class="o">+</span><span class="s1">&#39;GCN_Clustering.jpg&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;jpg&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">GCNlabels</span> <span class="o">=</span> <span class="n">GCNlabels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_TARGETS</span> <span class="o">=</span> <span class="n">NUM_TARGETS</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final number of targets: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_TARGETS</span><span class="p">))</span></div>

<div class="viewcode-block" id="IR_GEN._get_probabilities"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN._get_probabilities">[docs]</a>    <span class="k">def</span> <span class="nf">_get_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="p">):</span>
        <span class="c1">#define np_shuffle to be locally in loop</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="p">))</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_TARGETS</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">A</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">+</span><span class="n">probs</span>
            <span class="n">probabilities</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs</span>
        <span class="n">probabilities</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#set any slightly negative probabilities to 0</span>
        <span class="n">probabilities</span><span class="p">[</span><span class="n">probabilities</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**-</span><span class="mi">500</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">probabilities</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">probabilities</span></div>

<div class="viewcode-block" id="IR_GEN._perturb_spectra"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN._perturb_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">_perturb_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perturbations</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">1.001</span><span class="p">,</span> <span class="n">BINDING_TYPES</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">perturbed_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">perturbations</span>
                                                          <span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">+</span><span class="n">a</span>
        <span class="n">Xperturbed</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">perturbations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">perturbed_values</span>
        <span class="n">yperturbed</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">perturbations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">BINDING_TYPES</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">BINDING_TYPES</span> <span class="o">=</span> <span class="n">BINDING_TYPES</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">BINDING_TYPES_perturbed</span> <span class="o">=</span> <span class="n">BINDING_TYPES</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">perturbations</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">BINDING_TYPES_perturbed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Xperturbed</span><span class="p">,</span> <span class="n">yperturbed</span><span class="p">,</span> <span class="n">BINDING_TYPES_perturbed</span><span class="p">)</span></div>
   
<div class="viewcode-block" id="IR_GEN._mixed_lineshape"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN._mixed_lineshape">[docs]</a>    <span class="k">def</span> <span class="nf">_mixed_lineshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FWHM</span><span class="p">,</span> <span class="n">fL</span><span class="p">,</span> <span class="n">ENERGY_POINTS</span><span class="p">,</span> <span class="n">energy_spacing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;accepts numpy array of frequencies and intensities and FWHM</span>
<span class="sd">        returns spectrum</span>
<span class="sd">        Wertheim 1974&quot;&quot;&quot;</span>
        <span class="n">numpoints</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ENERGY_POINTS</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">energy_spacing</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numpoints</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span><span class="o">-</span><span class="nb">int</span><span class="p">((</span><span class="n">numpoints</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">specL</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="mf">4.0</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">FWHM</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">specG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">FWHM</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">fL</span><span class="o">*</span><span class="n">specL</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fL</span><span class="p">)</span><span class="o">*</span><span class="n">specG</span>
        <span class="k">return</span> <span class="n">transform</span></div>

<div class="viewcode-block" id="IR_GEN._coverage_shift"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN._coverage_shift">[docs]</a>    <span class="k">def</span> <span class="nf">_coverage_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">BINDING_TYPES</span><span class="p">,</span> <span class="n">SELF_COVERAGE</span><span class="p">,</span> <span class="n">TOTAL_COVERAGE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        COVERAGE: Relative spatial coverage of each binding-type</span>
<span class="sd">        TOTAL_COVERAGE: relative combined coverages of non-island</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coverage_scaling_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COV_SCALE_PATH</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">Xfrequencies</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Xintensities</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">SELF_COVERAGE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">SELF_COVERAGE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">SELF_COVERAGE</span> <span class="o">=</span> <span class="n">ones</span><span class="o">*</span><span class="n">SELF_COVERAGE</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">TOTAL_COVERAGE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">TOTAL_COVERAGE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">TOTAL_COVERAGE</span> <span class="o">=</span> <span class="n">ones</span><span class="o">*</span><span class="n">TOTAL_COVERAGE</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">coverage_scaling_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="n">Coverage_Scaling</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="c1">#maximum coverage obtained from Norton et al. 1982</span>
        <span class="n">ABS_COVERAGE</span> <span class="o">=</span> <span class="n">SELF_COVERAGE</span><span class="o">*</span><span class="mf">0.096</span>
        <span class="n">TOTAL_COVERAGE_ABS</span> <span class="o">=</span> <span class="n">TOTAL_COVERAGE</span><span class="o">*</span><span class="mf">0.096</span>
        <span class="c1">#site-type: atop, bridge,threefold,fourfold</span>
        <span class="n">CO_STRETCH_IDX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Xfrequencies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#Copy frequencies and update CO stretch before updating all, then set CO stretch</span>
        <span class="n">CO_frequencies</span> <span class="o">=</span> <span class="n">Xfrequencies</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xfrequencies</span><span class="p">)),</span> <span class="n">CO_STRETCH_IDX</span><span class="p">]</span>
        <span class="n">CO_intensities</span> <span class="o">=</span> <span class="n">Xintensities</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xintensities</span><span class="p">)),</span> <span class="n">CO_STRETCH_IDX</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">CO_frequencies</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">CO_frequencies</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>\
                                           <span class="o">*</span><span class="p">(</span><span class="n">Coverage_Scaling</span><span class="p">[</span><span class="s1">&#39;CO_FREQ&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;SELF_CO_PER_A2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ABS_COVERAGE</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>\
                                             <span class="o">+</span><span class="n">Coverage_Scaling</span><span class="p">[</span><span class="s1">&#39;CO_FREQ&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;CO_PER_A2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">TOTAL_COVERAGE_ABS</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>\
                                             <span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">CO_intensities</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">CO_intensities</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>\
                                         <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Coverage_Scaling</span><span class="p">[</span><span class="s1">&#39;CO_INT_EXP&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">TOTAL_COVERAGE_ABS</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            
            <span class="n">Xfrequencies</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xfrequencies</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>\
                                           <span class="o">*</span><span class="p">(</span><span class="n">Coverage_Scaling</span><span class="p">[</span><span class="s1">&#39;PTCO_FREQ&#39;</span><span class="p">][</span><span class="s1">&#39;SELF_CO_PER_A2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ABS_COVERAGE</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>\
                                             <span class="o">+</span><span class="n">Coverage_Scaling</span><span class="p">[</span><span class="s1">&#39;PTCO_FREQ&#39;</span><span class="p">][</span><span class="s1">&#39;CO_PER_A2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">TOTAL_COVERAGE_ABS</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>\
                                             <span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">Xintensities</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xintensities</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>\
                                         <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Coverage_Scaling</span><span class="p">[</span><span class="s1">&#39;PTCO_INT_EXP&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">TOTAL_COVERAGE_ABS</span><span class="p">[</span><span class="n">BINDING_TYPES</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>                          
        <span class="n">Xfrequencies</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">CO_STRETCH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">CO_frequencies</span>
        <span class="c1">#Xfrequencies cannot be less than 0</span>
        <span class="n">Xfrequencies</span><span class="p">[</span><span class="n">Xfrequencies</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">**-</span><span class="mi">500</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Xintensities</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">CO_STRETCH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">CO_intensities</span>
        <span class="n">Xcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">Xfrequencies</span><span class="p">,</span><span class="n">Xintensities</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Xcov</span></div>

<div class="viewcode-block" id="IR_GEN.scaling_factor_shift"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN.scaling_factor_shift">[docs]</a>    <span class="k">def</span> <span class="nf">scaling_factor_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">Xfrequencies</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Xintensities</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">CO_STRETCH_IDX</span> <span class="o">=</span> <span class="n">Xfrequencies</span> <span class="o">&gt;</span> <span class="mi">1000</span>
        <span class="n">MC_IDX</span> <span class="o">=</span> <span class="n">Xfrequencies</span> <span class="o">&lt;</span> <span class="mi">1000</span>
        <span class="c1">#Scaling Factor determined from comparing experiment to DFT</span>
        <span class="c1">#uncertainties are 0.00097 and 0.00182 respectively</span>
        
        <span class="n">SFCO</span> <span class="o">=</span> <span class="mf">1.0121</span>
        <span class="n">SFMC</span> <span class="o">=</span> <span class="mf">0.969</span>
        <span class="n">Xfrequencies</span><span class="p">[</span><span class="n">CO_STRETCH_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xfrequencies</span><span class="p">[</span><span class="n">CO_STRETCH_IDX</span><span class="p">]</span><span class="o">*</span><span class="n">SFCO</span>
        <span class="n">Xfrequencies</span><span class="p">[</span><span class="n">MC_IDX</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xfrequencies</span><span class="p">[</span><span class="n">MC_IDX</span><span class="p">]</span><span class="o">*</span><span class="n">SFMC</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">Xfrequencies</span><span class="p">,</span><span class="n">Xintensities</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span></div>
    
<div class="viewcode-block" id="IR_GEN._perturb_and_shift"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN._perturb_and_shift">[docs]</a>    <span class="k">def</span> <span class="nf">_perturb_and_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">perturbations</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">BINDING_TYPES</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ADSORBATE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADSORBATE</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Xperturbed</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">perturbations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">yperturbed</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">perturbations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">BINDING_TYPES</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">BINDING_TYPES</span> <span class="o">=</span> <span class="n">BINDING_TYPES</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">BINDING_TYPES_perturbed</span> <span class="o">=</span> <span class="n">BINDING_TYPES</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">perturbations</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">BINDING_TYPES_perturbed</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="n">Xfrequencies</span> <span class="o">=</span> <span class="n">Xperturbed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Xintensities</span> <span class="o">=</span> <span class="n">Xperturbed</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">CO_STRETCH_IDX</span> <span class="o">=</span> <span class="n">Xfrequencies</span> <span class="o">&gt;</span> <span class="mi">1000</span>
        <span class="n">MC_IDX</span> <span class="o">=</span> <span class="n">Xfrequencies</span> <span class="o">&lt;</span> <span class="mi">1000</span>
        <span class="c1">#Scaling Factor determined from comparing experiment to DFT</span>
        <span class="c1">#uncertainties are 0.00097 and 0.00182 respectively</span>
        <span class="n">SFCO</span> <span class="o">=</span> <span class="mf">1.0121</span>
        <span class="n">SFMC</span> <span class="o">=</span> <span class="mf">0.969</span>
        <span class="k">if</span> <span class="n">ADSORBATE</span> <span class="o">==</span> <span class="s1">&#39;CO&#39;</span><span class="p">:</span>
            <span class="n">perturb_CO_freq</span> <span class="o">=</span> <span class="mf">0.00097044</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">Xfrequencies</span><span class="p">[</span><span class="n">CO_STRETCH_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="n">SFCO</span>
            <span class="n">perturb_MC_freq</span> <span class="o">=</span> <span class="mf">0.00183104</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">Xfrequencies</span><span class="p">[</span><span class="n">MC_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="n">SFMC</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perturb_CO_freq</span> <span class="o">=</span> <span class="mf">0.00097044</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">Xfrequencies</span><span class="p">[</span><span class="n">CO_STRETCH_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">perturb_MC_freq</span> <span class="o">=</span> <span class="mf">0.00183104</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">Xfrequencies</span><span class="p">[</span><span class="n">MC_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="n">perturb_CO_int</span> <span class="o">=</span> <span class="mf">0.00097044</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">Xintensities</span><span class="p">[</span><span class="n">CO_STRETCH_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">perturb_MC_int</span> <span class="o">=</span> <span class="mf">0.00183104</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">Xintensities</span><span class="p">[</span><span class="n">MC_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="n">Xfrequencies</span><span class="p">[</span><span class="n">CO_STRETCH_IDX</span><span class="p">]</span> <span class="o">*=</span> <span class="n">perturb_CO_freq</span>
        <span class="n">Xfrequencies</span><span class="p">[</span><span class="n">MC_IDX</span><span class="p">]</span> <span class="o">*=</span> <span class="n">perturb_MC_freq</span>
        
        <span class="n">Xintensities</span><span class="p">[</span><span class="n">CO_STRETCH_IDX</span><span class="p">]</span> <span class="o">*=</span> <span class="n">perturb_CO_int</span>
        <span class="n">Xintensities</span><span class="p">[</span><span class="n">MC_IDX</span><span class="p">]</span> <span class="o">*=</span> <span class="n">perturb_MC_int</span>
        
        <span class="n">Xperturbed_and_shifted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">Xfrequencies</span><span class="p">,</span><span class="n">Xintensities</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Xperturbed_and_shifted</span><span class="p">[</span><span class="n">Xperturbed_and_shifted</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">**-</span><span class="mi">500</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Xperturbed_and_shifted</span><span class="p">,</span> <span class="n">yperturbed</span><span class="p">,</span> <span class="n">BINDING_TYPES_perturbed</span><span class="p">)</span></div>

<div class="viewcode-block" id="IR_GEN._generate_spectra"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN._generate_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">_generate_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Xfrequencies</span><span class="p">,</span> <span class="n">Xintensities</span><span class="p">,</span> <span class="n">energies2D</span><span class="p">,</span> <span class="n">prefactor</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="n">ENERGY_POINTS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ENERGY_POINTS</span>
        <span class="n">int_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Xfrequencies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ENERGY_POINTS</span><span class="p">))</span>
        <span class="c1">#mesh everything on energy grids of 4 cm-1 spacings with a FWHM of 2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Xfrequencies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">freq2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Xfrequencies</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">ENERGY_POINTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">int2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Xintensities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">ENERGY_POINTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">int2D</span><span class="o">*</span><span class="n">prefactor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">freq2D</span><span class="o">-</span><span class="n">energies2D</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">int_mesh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">int_mesh</span></div>
    
<div class="viewcode-block" id="IR_GEN._xyconv"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN._xyconv">[docs]</a>    <span class="k">def</span> <span class="nf">_xyconv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_sample</span><span class="p">,</span> <span class="n">Y_sample</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">BINDING_TYPES_sample</span><span class="p">):</span>
        <span class="n">get_probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_probabilities</span>
        <span class="n">mixed_lineshape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mixed_lineshape</span>
        <span class="n">_coverage_shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coverage_shift</span>
        <span class="n">generate_spectra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_spectra</span>
        <span class="n">NUM_TARGETS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_TARGETS</span>
        <span class="n">LOW_FREQUENCY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOW_FREQUENCY</span>
        <span class="n">HIGH_FREQUENCY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HIGH_FREQUENCY</span>
        <span class="n">ENERGY_POINTS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ENERGY_POINTS</span>
        <span class="n">COVERAGE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COVERAGE</span>
        <span class="n">TARGET</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TARGET</span>
        <span class="n">GCNlabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GCNlabels</span>
        <span class="n">INCLUDED_BINDING_TYPES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INCLUDED_BINDING_TYPES</span>
        <span class="n">MAX_COVERAGES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_COVERAGES</span>
        
        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">LOW_FREQUENCY</span><span class="p">,</span> <span class="n">HIGH_FREQUENCY</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">ENERGY_POINTS</span>\
                               <span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">energy_spacing</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">FWHM</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">energy_spacing</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">FWHM</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">prefactor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
        <span class="n">energies2D</span> <span class="o">=</span> <span class="n">energies</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">Xfrequencies</span> <span class="o">=</span> <span class="n">X_sample</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Xintensities</span> <span class="o">=</span> <span class="n">X_sample</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>
        <span class="n">num_simple_spectra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>
        <span class="n">fLs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)</span>
        <span class="n">FWHMs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>
        <span class="n">Xconv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">ENERGY_POINTS</span><span class="p">))</span>
        <span class="n">yconv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="p">))</span>
        <span class="n">y_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Y_sample</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="p">))</span>
        <span class="c1">#subtracting MIN_Y ensures that the number of indices in</span>
        <span class="c1">#ymin is equal to the labels, even if the labels don&#39;t start at 0</span>
        <span class="k">if</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;GCN&#39;</span><span class="p">:</span>
            <span class="n">MIN_Y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">GCNlabels</span><span class="p">[</span><span class="n">GCNlabels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">MIN_Y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">INCLUDED_BINDING_TYPES</span><span class="p">)</span>
        <span class="n">y_mesh</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Y_sample</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">Y_sample</span><span class="o">-</span><span class="n">MIN_Y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sample_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Y_sample</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">parray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Y_sample</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">shift_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Y_sample</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>                
        <span class="k">if</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;GCN&#39;</span> <span class="ow">or</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">COVERAGE</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">]:</span>
            <span class="n">int_mesh</span> <span class="o">=</span> <span class="n">generate_spectra</span><span class="p">(</span><span class="n">Xfrequencies</span><span class="p">,</span> <span class="n">Xintensities</span>\
                                        <span class="p">,</span><span class="n">energies2D</span><span class="p">,</span> <span class="n">prefactor</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coverage_parray</span> <span class="o">=</span> <span class="n">get_probabilities</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
            <span class="n">coverage_totals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">num_samples</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
            
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
            <span class="n">shift_vector</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">non_zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">Y_sample</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">indices_to_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">sample_indices</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">non_zeros</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">shift_vector</span><span class="p">[</span><span class="n">indices_to_shift</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">non_zeros</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_TARGETS</span><span class="p">):</span>
                <span class="n">ii_MIN_Y</span> <span class="o">=</span> <span class="n">ii</span><span class="o">+</span><span class="n">MIN_Y</span>
                <span class="n">shift_vector_sum</span> <span class="o">=</span> <span class="n">shift_vector</span><span class="p">[</span><span class="n">Y_sample</span> <span class="o">==</span> <span class="n">ii_MIN_Y</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">shift_vector_sum</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">shift_vector</span><span class="p">[</span><span class="n">Y_sample</span> <span class="o">==</span> <span class="n">ii_MIN_Y</span><span class="p">]</span> <span class="o">/=</span> <span class="n">shift_vector_sum</span>
                    <span class="n">parray</span><span class="p">[</span><span class="n">Y_sample</span> <span class="o">==</span> <span class="n">ii_MIN_Y</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">shift_vector</span><span class="p">[</span><span class="n">Y_sample</span><span class="o">==</span><span class="n">ii_MIN_Y</span><span class="p">]</span>       
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parray</span><span class="p">[</span><span class="n">Y_sample</span> <span class="o">==</span> <span class="n">ii_MIN_Y</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span>
            <span class="n">parray</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">parray</span><span class="p">)</span>
            <span class="n">indices_primary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">sample_indices</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_simple_spectra</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">parray</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;GCN&#39;</span> <span class="ow">or</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">COVERAGE</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">]:</span>
                <span class="n">combined_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">int_mesh</span><span class="p">[</span><span class="n">indices_primary</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#initialize coverages</span>
                <span class="n">SELF_COVERAGE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">num_simple_spectra</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">TOTAL_COVERAGE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">SELF_COVERAGE</span><span class="p">)</span>
                <span class="n">COVERAGE_INDICES</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">num_simple_spectra</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">coverage_parray</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="c1">#self coverage corresponding to index of 0 is island so it is single coverage and is skipped</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">COVERAGE_INDICES</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">TOTAL_COVERAGE</span><span class="p">[</span><span class="n">COVERAGE_INDICES</span> <span class="o">==</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">coverage_totals</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1">#Set coverage of each spectra to be total coverage divided by the number of spectra being combined</span>
                    <span class="n">SELF_COVERAGE</span><span class="p">[</span><span class="n">COVERAGE_INDICES</span> <span class="o">==</span> <span class="n">ii</span> <span class="p">]</span> <span class="o">=</span> <span class="n">coverage_totals</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">TOTAL_COVERAGE</span><span class="p">[</span><span class="n">COVERAGE_INDICES</span> <span class="o">==</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
                    <span class="c1">#update self coverage of indentical binding types to be the same (their sum)</span>
                    <span class="k">for</span> <span class="n">iii</span> <span class="ow">in</span> <span class="n">INCLUDED_BINDING_TYPES</span><span class="p">:</span>
                        <span class="n">SELF_COVERAGE</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">COVERAGE_INDICES</span> <span class="o">==</span> <span class="n">ii</span><span class="p">,</span><span class="n">BINDING_TYPES_sample</span><span class="p">[</span><span class="n">indices_primary</span><span class="p">]</span><span class="o">==</span><span class="n">iii</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span> \
                        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">SELF_COVERAGE</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">COVERAGE_INDICES</span> <span class="o">==</span> <span class="n">ii</span><span class="p">,</span><span class="n">BINDING_TYPES_sample</span><span class="p">[</span><span class="n">indices_primary</span><span class="p">]</span><span class="o">==</span><span class="n">iii</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)])</span>
                <span class="c1">#decrease maximum coverage at less favorable sites to improve prediction score</span>
                <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">max_coverage</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MAX_COVERAGES</span><span class="p">):</span>
                    <span class="n">SELF_COVERAGE</span><span class="p">[</span><span class="n">BINDING_TYPES_sample</span><span class="p">[</span><span class="n">indices_primary</span><span class="p">]</span> <span class="o">==</span> <span class="n">INCLUDED_BINDING_TYPES</span><span class="p">[</span><span class="n">count</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">max_coverage</span>
                <span class="c1">#Ensure that Total coverage is compatible with self_coverage</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">COVERAGE_INDICES</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">coverage_factor</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">max_coverage</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MAX_COVERAGES</span><span class="p">):</span>
                        <span class="n">coverage_factor</span> <span class="o">+=</span> <span class="n">max_coverage</span> <span class="o">*</span> \
                        <span class="n">SELF_COVERAGE</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">COVERAGE_INDICES</span> <span class="o">==</span> <span class="n">ii</span><span class="p">,</span><span class="n">BINDING_TYPES_sample</span><span class="p">[</span><span class="n">indices_primary</span><span class="p">]</span> <span class="o">==</span> <span class="n">INCLUDED_BINDING_TYPES</span><span class="p">[</span><span class="n">count</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">size</span>
                    <span class="n">TOTAL_COVERAGE</span><span class="p">[</span><span class="n">COVERAGE_INDICES</span> <span class="o">==</span> <span class="n">ii</span><span class="p">]</span> <span class="o">*=</span> <span class="n">coverage_factor</span><span class="o">/</span><span class="n">TOTAL_COVERAGE</span><span class="p">[</span><span class="n">COVERAGE_INDICES</span> <span class="o">==</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>        
                <span class="n">TOTAL_COVERAGE</span><span class="p">[</span><span class="n">COVERAGE_INDICES</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SELF_COVERAGE</span><span class="p">[</span><span class="n">COVERAGE_INDICES</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Xcov</span> <span class="o">=</span> <span class="n">_coverage_shift</span><span class="p">(</span><span class="n">X_sample</span><span class="p">[</span><span class="n">indices_primary</span><span class="p">],</span> <span class="n">BINDING_TYPES_sample</span><span class="p">[</span><span class="n">indices_primary</span><span class="p">],</span> <span class="n">SELF_COVERAGE</span><span class="p">,</span> <span class="n">TOTAL_COVERAGE</span><span class="p">)</span>
                <span class="n">Xcovfrequencies</span> <span class="o">=</span> <span class="n">Xcov</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">Xcovintensities</span> <span class="o">=</span> <span class="n">Xcov</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">int_mesh</span> <span class="o">=</span> <span class="n">generate_spectra</span><span class="p">(</span><span class="n">Xcovfrequencies</span><span class="p">,</span><span class="n">Xcovintensities</span>\
                                                  <span class="p">,</span><span class="n">energies2D</span><span class="p">,</span> <span class="n">prefactor</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">max_coverage</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MAX_COVERAGES</span><span class="p">):</span>
                    <span class="n">int_mesh</span><span class="p">[</span><span class="n">BINDING_TYPES_sample</span><span class="p">[</span><span class="n">indices_primary</span><span class="p">]</span> <span class="o">==</span> <span class="n">INCLUDED_BINDING_TYPES</span><span class="p">[</span><span class="n">count</span><span class="p">]]</span> <span class="o">*=</span> <span class="n">max_coverage</span>
                <span class="n">combined_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">int_mesh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">yconv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_mesh</span><span class="p">[</span><span class="n">indices_primary</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">mixed_lineshape</span><span class="p">(</span><span class="n">FWHMs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fLs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ENERGY_POINTS</span><span class="p">,</span> <span class="n">energy_spacing</span><span class="p">)</span>
            <span class="n">Xconv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">combined_mesh</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="c1">#This part is to adjust the tabulated contribution to match that of the adjusted spectra for max coverage of bridge, 3-fold and 4-fold</span>
        <span class="k">if</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;binding_type&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">max_coverage</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MAX_COVERAGES</span><span class="p">):</span>
                    <span class="n">yconv</span><span class="p">[:,</span><span class="n">count</span><span class="p">]</span> <span class="o">*=</span> <span class="n">max_coverage</span>
            <span class="k">if</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;combine_hollow_sites&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">max_coverage</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MAX_COVERAGES</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">MAX_COVERAGES</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">yconv</span><span class="p">[:,</span><span class="n">count</span><span class="p">]</span> <span class="o">*=</span> <span class="n">max_coverage</span>
        <span class="c1">#10**-4 accounts for noise in experimental spectra</span>
        <span class="n">Xconv</span> <span class="o">+=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Xconv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">Xconv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1">#normalize so max X is 1 and make y a set of fractions that sum to 1</span>
        <span class="n">Xconv</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Xconv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">yconv</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yconv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Xconv</span><span class="p">,</span> <span class="n">yconv</span><span class="p">)</span></div>

<div class="viewcode-block" id="IR_GEN.add_noise"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN.add_noise">[docs]</a>    <span class="k">def</span> <span class="nf">add_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Xconv_main</span><span class="p">,</span> <span class="n">Xconv_noise</span><span class="p">,</span> <span class="n">noise2signalmax</span><span class="o">=</span><span class="mf">0.67</span><span class="p">):</span>
        <span class="n">X_noisey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Xconv_main</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xconv_main</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">noise_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">noise2signalmax</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">Xconv_main</span><span class="p">))</span>
        <span class="n">noise_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xconv_noise</span><span class="p">))</span>
        <span class="n">noise_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">noise_indices</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">Xconv_main</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xconv_main</span><span class="p">)):</span>
            <span class="n">X_noisey</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xconv_main</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Xconv_noise</span><span class="p">[</span><span class="n">noise_sample</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">*</span><span class="n">noise_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">X_noisey</span> <span class="o">=</span> <span class="n">X_noisey</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_noisey</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X_noisey</span></div>

<div class="viewcode-block" id="IR_GEN.get_synthetic_spectra"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN.get_synthetic_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">get_synthetic_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NUM_SAMPLES</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">COVERAGE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">MAX_COVERAGES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>\
                              <span class="p">,</span> <span class="n">LOW_FREQUENCY</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">HIGH_FREQUENCY</span><span class="o">=</span><span class="mi">2200</span><span class="p">,</span> <span class="n">ENERGY_POINTS</span><span class="o">=</span><span class="mi">501</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">COVERAGE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;get_synthetic_spectra is intended </span><span class="se">\</span>
<span class="s2">        to be run only once. Please run get_more_spectra.&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">COVERAGE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="n">COVERAGE</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">COVERAGE</span> \
        <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="s2">&quot;Coverage should be a float, &#39;low&#39;, or &#39;high&#39;.&quot;</span>
        <span class="n">_coverage_shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coverage_shift</span>
        <span class="n">_get_probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_probabilities</span>
        <span class="n">_perturb_spectra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perturb_spectra</span>
        <span class="n">_perturb_and_shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perturb_and_shift</span>
        <span class="n">_xyconv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span> <span class="n">_xyconv</span>
        <span class="n">high_coverage_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HIGH_COV_PATH</span>
        <span class="n">TARGET</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TARGET</span>
        <span class="n">NUM_TARGETS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_TARGETS</span>
        <span class="n">BINDING_TYPES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BINDING_TYPES</span>
        <span class="n">BINDING_TYPES_with_4fold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BINDING_TYPES_with_4fold</span>
        <span class="n">X0cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X0cov</span>
        <span class="n">GCNlabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GCNlabels</span>
        <span class="c1">#Assign the target variable Y to either GCN group or binding site</span>
        <span class="k">if</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;GCN&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">GCNlabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;get_GCNlabels must be executed before spectra can be generated&quot;</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">GCNlabels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">BINDING_TYPES</span>
        <span class="c1">#Adding Data for Extended Surfaces</span>
        <span class="k">if</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;GCN&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding high-coverage low index planes&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial number of targets: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">NUM_TARGETS</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">high_coverage_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
                <span class="n">HC_Ext</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
            <span class="n">HC_CNPt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">HC_Ext</span><span class="p">[</span><span class="s1">&#39;CN_METAL&#39;</span><span class="p">]]))))</span>
            <span class="n">NUM_TARGETS</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">HC_CNPt</span><span class="p">)</span>
            <span class="n">HC_frequencies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">HC_intensities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">HC_classes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">max_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">HC_Ext</span><span class="p">[</span><span class="s1">&#39;FREQUENCIES&#39;</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">HC_CNPt</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">HC_Ext</span><span class="p">[</span><span class="s1">&#39;CN_METAL&#39;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">HC_Ext</span><span class="p">[</span><span class="s1">&#39;CN_METAL&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">HC_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">+</span><span class="n">counter</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">num_atop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HC_Ext</span><span class="p">[</span><span class="s1">&#39;CN_ADSORBATE&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
                                               <span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HC_Ext</span><span class="p">[</span><span class="s1">&#39;CN_ADSORBATE&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="n">max_freqs</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">HC_Ext</span><span class="p">[</span><span class="s1">&#39;FREQUENCIES&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span>
                        <span class="n">HC_frequencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">HC_Ext</span><span class="p">[</span><span class="s1">&#39;FREQUENCIES&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
                                                     <span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">HC_intensities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">HC_Ext</span><span class="p">[</span><span class="s1">&#39;INTENSITIES&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
                                                     <span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">num_atop</span><span class="p">)</span>
            <span class="n">HC_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HC_classes</span><span class="p">)</span>
            <span class="c1">#Change all high-coverage classes to just max(y)+1</span>
            <span class="c1">#until more accurate experiments and DFT are available</span>
            <span class="n">NUM_TARGETS</span> <span class="o">=</span> <span class="n">NUM_TARGETS</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">HC_CNPt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">HC_classes</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">NUM_TARGETS</span>
            <span class="c1">#</span>
            <span class="n">HC_frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HC_frequencies</span><span class="p">)</span>
            <span class="n">HC_intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HC_intensities</span><span class="p">)</span>
            <span class="n">HC_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">HC_frequencies</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HC_intensities</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">HC_frequencies</span><span class="p">))])</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">max_freqs</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">X0cov</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">X0cov</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final number of targets: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">NUM_TARGETS</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">TARGET</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;binding_type&#39;</span><span class="p">,</span> <span class="s1">&#39;combine_hollow_sites&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;testing all coverages&#39;</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X0cov</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">COVERAGE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">COVERAGE</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Relative coverage is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">COVERAGE</span><span class="p">))</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">_coverage_shift</span><span class="p">(</span><span class="n">X0cov</span><span class="p">,</span> <span class="n">BINDING_TYPES_with_4fold</span><span class="p">,</span> <span class="n">COVERAGE</span><span class="p">,</span><span class="n">COVERAGE</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X0cov</span>
        <span class="n">X_new</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Y_new</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;GCN&#39;</span><span class="p">:</span>
            <span class="n">num_single</span> <span class="o">=</span> <span class="n">Y_new</span><span class="o">.</span><span class="n">size</span>
            <span class="c1">#b = 2105/2095 #a = 1854/1865 - difference between experiments and DFT</span>
            <span class="n">HC_X_expanded</span><span class="p">,</span> <span class="n">HC_classes_expanded</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_perturb_spectra</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">HC_X</span><span class="p">,</span> <span class="n">HC_classes</span>
                                                                       <span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.997</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">1.007</span><span class="p">)</span>
            <span class="n">X_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X_new</span><span class="p">,</span> <span class="n">HC_X_expanded</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">Y_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y_new</span><span class="p">,</span> <span class="n">HC_classes_expanded</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Y_new</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">num_single</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">Y_new</span><span class="p">[</span><span class="n">indices</span><span class="p">]))</span> <span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">indices_balanced</span><span class="p">,</span> <span class="n">Y_balanced</span> <span class="o">=</span> <span class="n">RandomOverSampler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_sample</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">Y_new</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices_balanced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">Y_balanced</span> <span class="o">=</span> <span class="n">Y_new</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">X_balanced</span> <span class="o">=</span> <span class="n">X_new</span><span class="p">[</span><span class="n">indices_balanced</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
        <span class="c1">#BINDING_TYPES_balanced used only if COVERAGE == &#39;high&#39; and (TARGET == &#39;binding_type&#39; or TARGET == &#39;combine_hollow_sites&#39;)</span>
        <span class="k">if</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">TARGET</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;binding_type&#39;</span><span class="p">,</span> <span class="s1">&#39;combine_hollow_sites&#39;</span><span class="p">]:</span>
            <span class="n">BINDING_TYPES_balanced</span> <span class="o">=</span> <span class="n">BINDING_TYPES_with_4fold</span><span class="p">[</span><span class="n">indices_balanced</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">BINDING_TYPES_balanced</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#adding perturbations for improved fitting by account for frequency and intensity errors from DFT</span>
        <span class="n">X_sample</span><span class="p">,</span> <span class="n">Y_sample</span><span class="p">,</span> <span class="n">BINDING_TYPES_sample</span> <span class="o">=</span> <span class="n">_perturb_and_shift</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">X_balanced</span><span class="p">,</span> <span class="n">Y_balanced</span><span class="p">,</span> <span class="n">BINDING_TYPES_balanced</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">_get_probabilities</span><span class="p">(</span><span class="n">NUM_SAMPLES</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;GCN&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HC_X</span> <span class="o">=</span> <span class="n">HC_X</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HC_classes</span> <span class="o">=</span> <span class="n">HC_classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_TARGETS</span> <span class="o">=</span> <span class="n">NUM_TARGETS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X0cov</span> <span class="o">=</span> <span class="n">X0cov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COVERAGE</span> <span class="o">=</span> <span class="n">COVERAGE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOW_FREQUENCY</span> <span class="o">=</span> <span class="n">LOW_FREQUENCY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HIGH_FREQUENCY</span> <span class="o">=</span> <span class="n">HIGH_FREQUENCY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ENERGY_POINTS</span> <span class="o">=</span> <span class="n">ENERGY_POINTS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAX_COVERAGES</span> <span class="o">=</span> <span class="n">MAX_COVERAGES</span>
        <span class="n">Xconv</span><span class="p">,</span> <span class="n">yconv</span> <span class="o">=</span> <span class="n">_xyconv</span><span class="p">(</span><span class="n">X_sample</span><span class="p">,</span> <span class="n">Y_sample</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">BINDING_TYPES_sample</span><span class="p">)</span>
        <span class="c1">#set numbers that may form denormals to zero to improve numerics</span>
        <span class="n">Xconv</span><span class="p">[</span><span class="n">Xconv</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">**-</span><span class="mi">500</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">yconv</span><span class="p">[</span><span class="n">yconv</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">**-</span><span class="mi">500</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Xconv</span><span class="p">,</span> <span class="n">yconv</span><span class="p">)</span></div>

<div class="viewcode-block" id="IR_GEN.get_more_spectra"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.IR_GEN.get_more_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">get_more_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NUM_SAMPLES</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="n">_perturb_spectra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perturb_spectra</span>
        <span class="n">_perturb_and_shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perturb_and_shift</span>
        <span class="n">_get_probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_probabilities</span>
        <span class="n">_xyconv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span> <span class="n">_xyconv</span>
        <span class="n">NUM_TARGETS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_TARGETS</span>
        <span class="n">X_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Y_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">TARGET</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TARGET</span>
        <span class="n">BINDING_TYPES_with_4fold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BINDING_TYPES_with_4fold</span>
        <span class="n">COVERAGE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COVERAGE</span>
        <span class="k">if</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">TARGET</span> <span class="o">==</span> <span class="s1">&#39;GCN&#39;</span><span class="p">:</span>
            <span class="n">HC_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HC_X</span>
            <span class="n">HC_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HC_classes</span>
            <span class="n">num_single</span> <span class="o">=</span> <span class="n">Y_new</span><span class="o">.</span><span class="n">size</span>
            <span class="c1">#b = 2105/2095 #a = 1854/1865 difference between experiments and DFT</span>
            <span class="n">HC_X_expanded</span><span class="p">,</span> <span class="n">HC_classes_expanded</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_perturb_spectra</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">HC_X</span><span class="p">,</span> <span class="n">HC_classes</span>
                                                                       <span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.997</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">1.07</span><span class="p">)</span>
            <span class="n">X_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X_new</span><span class="p">,</span> <span class="n">HC_X_expanded</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">Y_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y_new</span><span class="p">,</span> <span class="n">HC_classes_expanded</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Y_new</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">num_single</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> 
       
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">Y_new</span><span class="p">[</span><span class="n">indices</span><span class="p">]))</span> <span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">indices_balanced</span><span class="p">,</span> <span class="n">Y_balanced</span> <span class="o">=</span> <span class="n">RandomOverSampler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_sample</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">Y_new</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices_balanced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">Y_balanced</span> <span class="o">=</span> <span class="n">Y_new</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">X_balanced</span> <span class="o">=</span> <span class="n">X_new</span><span class="p">[</span><span class="n">indices_balanced</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
        <span class="c1">#only use BINDING_TYPES_balanced if COVERAGE == &#39;high&#39; and (TARGET == &#39;binding_type&#39; or TARGET == &#39;combine_hollow_sites&#39;)</span>
        <span class="k">if</span> <span class="n">COVERAGE</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">TARGET</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;binding_type&#39;</span><span class="p">,</span> <span class="s1">&#39;combine_hollow_sites&#39;</span><span class="p">]:</span>
            <span class="n">BINDING_TYPES_balanced</span> <span class="o">=</span> <span class="n">BINDING_TYPES_with_4fold</span><span class="p">[</span><span class="n">indices_balanced</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">BINDING_TYPES_balanced</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#adding perturbations for improved fitting by account for frequency and intensity errors from DFT</span>
        <span class="n">X_sample</span><span class="p">,</span> <span class="n">Y_sample</span><span class="p">,</span> <span class="n">BINDING_TYPES_sample</span> <span class="o">=</span> <span class="n">_perturb_and_shift</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">X_balanced</span><span class="p">,</span> <span class="n">Y_balanced</span><span class="p">,</span> <span class="n">BINDING_TYPES_balanced</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">_get_probabilities</span><span class="p">(</span><span class="n">NUM_SAMPLES</span><span class="p">,</span> <span class="n">NUM_TARGETS</span><span class="p">)</span>
        <span class="n">Xconv</span><span class="p">,</span> <span class="n">yconv</span> <span class="o">=</span> <span class="n">_xyconv</span><span class="p">(</span><span class="n">X_sample</span><span class="p">,</span> <span class="n">Y_sample</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">BINDING_TYPES_sample</span><span class="p">)</span>
        <span class="c1">#set numbers that may form denormals to zero to improve numerics</span>
        <span class="n">Xconv</span><span class="p">[</span><span class="n">Xconv</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">**-</span><span class="mi">500</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">yconv</span><span class="p">[</span><span class="n">yconv</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">**-</span><span class="mi">500</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Xconv</span><span class="p">,</span> <span class="n">yconv</span><span class="p">)</span></div></div>
    
<div class="viewcode-block" id="fold"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.fold">[docs]</a><span class="k">def</span> <span class="nf">fold</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">LOW_FREQUENCY</span><span class="p">,</span> <span class="n">HIGH_FREQUENCY</span><span class="p">,</span> <span class="n">ENERGY_POINTS</span><span class="p">,</span><span class="n">FWHM</span><span class="p">):</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">LOW_FREQUENCY</span><span class="p">,</span> <span class="n">HIGH_FREQUENCY</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">ENERGY_POINTS</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">energy_spacing</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">FWHM</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">energy_spacing</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Function input FWHM must must be at least twice</span><span class="se">\</span>
<span class="s1">        the energy spacing to prevent information loss. It therefore must be</span><span class="se">\</span>
<span class="s1">        at least&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">energy_spacing</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">HIGH_FREQUENCY</span> <span class="o">&gt;</span> <span class="n">LOW_FREQUENCY</span><span class="p">,</span> <span class="s2">&quot;The high frequency must be greater than the low frequenc&quot;</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">FWHM</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
    <span class="n">prefactor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="c1">#Reshape array energies to be (ENERGY_POINTS,1) dimensional</span>
    <span class="n">energies2D</span> <span class="o">=</span> <span class="n">energies</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1">#Create array that is duplicate of frequencies</span>
    <span class="n">freq2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="p">(</span><span class="n">ENERGY_POINTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">int2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">intensities</span><span class="p">,</span> <span class="p">(</span><span class="n">ENERGY_POINTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1">#contribution of each frequency on each energy to total intensity</span>
    <span class="n">int_matrix</span> <span class="o">=</span> <span class="n">int2D</span><span class="o">*</span><span class="n">prefactor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">freq2D</span><span class="o">-</span><span class="n">energies2D</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">int_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spectrum</span></div>

<div class="viewcode-block" id="HREEL_2_scaledIR"><a class="viewcode-back" href="../../jl_spectra_2_structure.html#jl_spectra_2_structure.jl_spectra_2_structure.HREEL_2_scaledIR">[docs]</a><span class="k">def</span> <span class="nf">HREEL_2_scaledIR</span><span class="p">(</span><span class="n">HREEL</span><span class="p">,</span> <span class="n">frequency_range</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="k">if</span> <span class="n">frequency_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">frequency_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">2200</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">501</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">PEAK_CONV</span> <span class="o">=</span> <span class="mf">2.7</span>
    <span class="n">IR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">frequency_range</span><span class="p">,</span> <span class="n">HREEL</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">HREEL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">HREEL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="n">PEAK_CONV</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">IR_scaled</span> <span class="o">=</span> <span class="n">IR</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">IR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">IR_scaled</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Joshua Lansford

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>